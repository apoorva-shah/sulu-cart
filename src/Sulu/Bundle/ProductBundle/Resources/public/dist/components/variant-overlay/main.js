define(["config","suluproduct/models/product","text!suluproduct/components/variant-overlay/details.html","text!suluproduct/components/variant-overlay/prices.html","text!suluproduct/components/variant-overlay/warning.html"],function(a,b,c,d,e){"use strict";var f={currencies:[],data:{},instanceName:null,locale:null,variantAttributes:[],parentPrices:[],parentName:""},g={form:"#js-variant-form",overlayContent:".variant-overlay-content",priceCheckbox:".change-price",priceInput:".salesprice"},h="sulu.product-variant-overlay.",i=function(){return k.call(this,"closed")},j=function(){return k.call(this,"initialized")},k=function(a){return h+m.call(this)+a},l=function(a){return"husky.overlay."+m.call(this)+a},m=function(){var a="";return"string"==typeof this.options.instanceName&&(a+="."),a},n=function(){this.sandbox.on(l.call(this,"language-changed"),q.bind(this)),this.sandbox.on(l.call(this,"closed"),o.bind(this))},o=function(){this.sandbox.stop(this.$el),this.sandbox.emit(i.call(this))},p=function(){this.sandbox.dom.on(this.$el,"click",u.bind(this),g.priceCheckbox),this.sandbox.dom.on(this.$el,"focusout",J.bind(this),g.priceInput)},q=function(a){this.changeLocale=a,this.sandbox.emit(l.call(this,"slide-right"))},r=function(){return this.sandbox.emit(l.call(this,"slide-left")),t.call(this,this.changeLocale),!1},s=function(){var a=this.sandbox.sulu.locales;return this.sandbox.emit(l.call(this,"slide-left")),this.sandbox.emit("husky.select.null.update",a,[a.indexOf(this.options.locale)],!1),!1},t=function(a){this.options.locale=a,z.call(this)},u=function(a){var b=$(a.target).data("currencyCode"),c=$("#price-"+b),d=!1;c.prop("disabled",function(a,b){return d=!b}),d?c.val(""):c.focus()},v=function(){return[{title:this.sandbox.translate("public.details"),data:this.sandbox.dom.createElement(_.template(c,{translate:this.sandbox.translate}))},{title:this.sandbox.translate("content-navigation.product.pricing"),data:this.sandbox.dom.createElement(_.template(d,{translate:this.sandbox.translate}))}]},w=function(){var a=this.sandbox.dom.createElement('<div id="js-variant-form"/>');this.sandbox.dom.append(this.$el,a);var b=this.sandbox.translate("sulu_product.variant-overlay.title");this.options.data.id&&(b=this.sandbox.translate("sulu_product.variant-overlay.title-edit"));this.sandbox.start([{name:"overlay@husky",options:{el:a,supportKeyInput:!1,title:b,skin:"normal",openOnStart:!0,removeOnClose:!0,instanceName:this.options.instanceName,slides:[{title:b,tabs:v.call(this),languageChanger:{locales:this.sandbox.sulu.locales,preSelected:this.options.locale},propagateEvents:!1,okCallback:L.bind(this)},{title:this.sandbox.translate("sulu_product.variant-overlay.warning-title"),data:this.sandbox.dom.createElement(_.template(e,{translate:this.sandbox.translate})),okCallback:r.bind(this),cancelCallback:s.bind(this)}]}}]);this.sandbox.once(l.call(this,"opened"),function(){z.call(this),this.sandbox.emit(j.call(this))}.bind(this))},x=function(){$(g.overlayContent).addClass("is-hidden"),this.sandbox.emit(l.call(this,"show-loader"))},y=function(){$(g.overlayContent).removeClass("is-hidden"),this.sandbox.emit(l.call(this,"hide-loader"))},z=function(){this.options.data&&this.options.data.id&&x.call(this),A.call(this).then(function(a){a||(a={name:this.options.parentName,attributes:D.call(this)}),H.call(this,a),B.call(this,a)}.bind(this))},A=function(){var a=$.Deferred();if(this.options.data&&this.options.data.id){var c=b.findOrCreate({id:this.options.data.id});c.fetchLocale(this.options.locale,{success:function(b){a.resolve(b.toJSON())},error:function(){a.reject(),console.error("Error while fetching product data")}})}else a.resolve();return a.promise()},B=function(a){this.form||(this.form=this.sandbox.form.create(g.form)),this.form.initialized.then(C.bind(this,a))},C=function(a){this.sandbox.form.setData(g.form,a).then(function(){y.call(this)}.bind(this))},D=function(){var a=[];return this.sandbox.util.foreach(this.options.variantAttributes,function(b){a.push({attributeId:b.id,attributeName:b.name})}),a},E=function(a,b){var c=null;return a&&a.prices&&a.prices.length&&this.sandbox.util.foreach(a.prices,function(a){return a.currency.id===b?(c=a,!1):void 0}),c},F=function(a){if(this.options.parentPrices&&this.options.parentPrices.length){var b=null;this.sandbox.util.foreach(this.options.parentPrices,function(c){return c.currency.id===a&&0===parseInt(c.minimumQuantity)?(b=c,!1):void 0}.bind(this))}return b},G=function(a){var b="-",c=F.call(this,a);return c&&c.hasOwnProperty("price")&&(b=this.sandbox.numberFormat(c.price,"n2")),b},H=function(a){var b=[];this.sandbox.util.foreach(this.options.currencies,function(c){var d=E.call(this,a,c.id);d?d.hasOwnProperty("price")||(d.price=null):d={price:null,currency:c},d.basePrice=G.call(this,c.id),b.push(d)}.bind(this)),a.prices=b},I=function(a){var b=[];""===a.id&&delete a.id,this.sandbox.util.foreach(a.attributes,function(a){a.attributeId=parseInt(a.attributeId)}),this.sandbox.util.foreach(a.prices,function(a){""!==a.price&&(a.price=parseInt(a.price),b.push(a))}),a.prices=b},J=function(){var a=!0,b=$(g.priceInput);return this.sandbox.util.foreach(b,function(b){var c=$(b),d=c.prop("disabled")||this.sandbox.form.element.validate(c)&&c.val().length>0;d?c.parent().removeClass("husky-validate-error"):(c.parent().addClass("husky-validate-error"),a=!1)}.bind(this)),a},K=function(a){var b=$(".overlay-tabs li");b.hasOwnProperty(a)&&b[a].click()},L=function(){if(!J.call(this))return this.sandbox.emit("husky.tabs.item.select",K(1)),!1;if(!this.sandbox.form.validate(g.form))return this.sandbox.emit("husky.tabs.item.select",K(0)),!1;var a=this.sandbox.form.getData(g.form);I.call(this,a),"function"==typeof this.options.okCallback&&this.options.okCallback.call(this,a,this.options.locale)};return{initialize:function(){this.changeLocale=null,this.options=this.sandbox.util.extend(!0,{},f,this.options),w.call(this),n.call(this),p.call(this)}}});